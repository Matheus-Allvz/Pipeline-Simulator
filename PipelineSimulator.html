<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Pipeline e Cache (RV32I)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .font-mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="container mx-auto p-4 max-w-7xl">
        <h1 class="text-3xl font-bold text-center mb-6">Simulador de Pipeline e Cache (RV32I)</h1>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Configuração</h2>
                
                <label for="code-input" class="block mb-2 font-medium">Código Assembly (RV32I):</label>
                <textarea id="code-input" rows="10" class="w-full p-2 bg-gray-900 text-gray-100 rounded border border-gray-700 font-mono" placeholder="addi x1, x0, 10&#10;addi x2, x0, 20&#10;add x3, x1, x2&#10;sw x3, 4(x0)&#10;lw x4, 4(x0)&#10;beq x1, x2, 2&#10;jal x0, 4"></textarea>
                
                <button id="load-program" class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                    Carregar Programa
                </button>

                <h3 class="text-lg font-semibold mt-6 mb-3">Configurações da Cache (Placeholder)</h3>
                <div class="space-y-2">
                    <div>
                        <label for="l1i-latency" class="text-sm">Latência L1I:</label>
                        <input type="number" id="l1i-latency" value="1" class="w-full p-1 bg-gray-700 rounded" disabled>
                    </div>
                    <div>
                        <label for="l1d-latency" class="text-sm">Latência L1D:</label>
                        <input type="number" id="l1d-latency" value="1" class="w-full p-1 bg-gray-700 rounded" disabled>
                    </div>
                    <div>
                        <label for="miss-penalty" class="text-sm">Penalidade de Miss:</label>
                        <input type="number" id="miss-penalty" value="10" class="w-full p-1 bg-gray-700 rounded" disabled>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Estado do Pipeline</h2>
                <table class="w-full table-auto font-mono">
                    <thead class="border-b border-gray-600">
                        <tr>
                            <th class="text-left py-2 px-1">Estágio</th>
                            <th class="text-left py-2 px-1">Instrução</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="font-bold py-1 px-1">IF (Busca)</td>
                            <td id="pipeline-if" class="py-1 px-1">vazio</td>
                        </tr>
                        <tr>
                            <td class="font-bold py-1 px-1">ID (Decod.)</td>
                            <td id="pipeline-id" class="py-1 px-1">vazio</td>
                        </tr>
                        <tr>
                            <td class="font-bold py-1 px-1">EX (Exec.)</td>
                            <td id="pipeline-ex" class="py-1 px-1">vazio</td>
                        </tr>
                        <tr>
                            <td class="font-bold py-1 px-1">MEM (Memória)</td>
                            <td id="pipeline-mem" class="py-1 px-1">vazio</td>
                        </tr>
                        <tr>
                            <td class="font-bold py-1 px-1">WB (Escrita)</td>
                            <td id="pipeline-wb" class="py-1 px-1">vazio</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold mb-4">Estado do Sistema</h2>

                <h3 class="text-lg font-semibold mb-2">Métricas</h3>
                <table class="w-full table-auto mb-4 font-mono">
                    <tbody>
                        <tr>
                            <td class="py-1">PC:</td>
                            <td id="metrics-pc" class="text-right">0</td>
                        </tr>
                        <tr>
                            <td class="py-1">Ciclos:</td>
                            <td id="metrics-cycles" class="text-right">0</td>
                        </tr>
                        <tr>
                            <td class="py-1">Instruções:</td>
                            <td id="metrics-instructions" class="text-right">0</td>
                        </tr>
                        <tr>
                            <td class="py-1">CPI:</td>
                            <td id="metrics-cpi" class="text-right">0.00</td>
                        </tr>
                    </tbody>
                </table>
                
                <h3 class="text-lg font-semibold mb-2">Registradores (x0-x31)</h3>
                <div class="max-h-80 overflow-y-auto border border-gray-700 rounded">
                    <table class="w-full table-auto font-mono text-sm">
                        <thead class="bg-gray-700 sticky top-0">
                            <tr>
                                <th class="text-left py-1 px-2">Reg</th>
                                <th class="text-left py-1 px-2">Valor (Hex)</th>
                                <th class="text-left py-1 px-2">Valor (Dec)</th>
                            </tr>
                        </thead>
                        <tbody id="registers-table-body">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>

        <div class="mt-6 p-4 bg-gray-800 rounded-lg shadow-lg text-center">
            <h2 class="text-xl font-semibold mb-4">Controles</h2>
            <button id="btn-step" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded mr-2">
                Executar (Cycle)
            </button>
            <button id="btn-run" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-6 rounded mr-2">
                Executar (Completo)
            </button>
            <button id="btn-reset" class="bg-red-600 hover:bg-red-600 text-white font-bold py-2 px-6 rounded">
                Resetar
            </button>
        </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const simulator = {
                // Estado do Sistema
                registers: new Array(32).fill(0),
                dataMemory: new Uint8Array(1024), // 1KB de memória de dados
                instructionMemory: [], // Memória de instruções (array de objetos)
                pc: 0, // Program Counter (índice para instructionMemory)

                // Estado do Pipeline
                pipelineStages: {
                    IF: null,
                    ID: null,
                    EX: null,
                    MEM: null,
                    WB: null,
                },

                // Métricas
                metrics: {
                    cycles: 0,
                    instructions: 0,
                },

                // Referências da UI
                ui: {
                    pipeline: {
                        if: document.getElementById('pipeline-if'),
                        id: document.getElementById('pipeline-id'),
                        ex: document.getElementById('pipeline-ex'),
                        mem: document.getElementById('pipeline-mem'),
                        wb: document.getElementById('pipeline-wb'),
                    },
                    metrics: {
                        pc: document.getElementById('metrics-pc'),
                        cycles: document.getElementById('metrics-cycles'),
                        instructions: document.getElementById('metrics-instructions'),
                        cpi: document.getElementById('metrics-cpi'),
                    },
                    registersTableBody: document.getElementById('registers-table-body'),
                    buttons: {
                        step: document.getElementById('btn-step'),
                        run: document.getElementById('btn-run'),
                        reset: document.getElementById('btn-reset'),
                        loadProgram: document.getElementById('load-program'),
                    },
                    codeInput: document.getElementById('code-input'),
                },

                // Função de Inicialização
                init: function() {
                    console.log("Simulador iniciado.");
                    this.buildRegisterTable();
                    this.reset();
                    this.setupEventListeners();
                },

                // Constrói a tabela de registradores
                buildRegisterTable: function() {
                    let html = '';
                    for (let i = 0; i < 32; i++) {
                        html += `
                            <tr class="border-t border-gray-700 hover:bg-gray-700">
                                <td class="py-1 px-2 font-bold">x${i}</td>
                                <td class="py-1 px-2" id="reg-hex-${i}">0x00000000</td>
                                <td class="py-1 px-2" id="reg-dec-${i}">0</td>
                            </tr>`;
                    }
                    this.ui.registersTableBody.innerHTML = html;
                },

                // Configura os botões
                setupEventListeners: function() {
                    this.ui.buttons.step.addEventListener('click', this.step.bind(this));
                    this.ui.buttons.run.addEventListener('click', this.run.bind(this));
                    this.ui.buttons.reset.addEventListener('click', this.reset.bind(this));
                    this.ui.buttons.loadProgram.addEventListener('click', this.loadProgram.bind(this));
                },

                // Reseta o simulador para o estado inicial
                reset: function() {
                    console.log("Resetando simulador...");
                    this.registers.fill(0);
                    this.dataMemory.fill(0);
                    this.instructionMemory = [];
                    this.pc = 0;
                    
                    this.pipelineStages = {
                        IF: null, ID: null, EX: null, MEM: null, WB: null,
                    };
                    
                    this.metrics = { cycles: 0, instructions: 0 };

                    this.updateUI();
                },

                // Carrega o programa do <textarea>
                loadProgram: function() {
                    console.log("Carregando programa...");
                    this.reset(); // Limpa o estado antigo
                    const code = this.ui.codeInput.value;
                    this.parse(code);
                    console.log("Programa carregado:", this.instructionMemory);
                    this.updateUI();
                },

                /**
                 * Converte uma string de registrador (ex: 'x1', 'r5') para seu número.
                 * @param {string} r - A string do registrador.
                 * @returns {number} O número do registrador.
                 */
                parseRegister: function(r) {
                    if (!r) return NaN;
                    return parseInt(r.replace('x', '').replace('r', ''));
                },

                /**
                 * Analisa o código-fonte assembly e o armazena em instructionMemory.
                 * @param {string} code - O código-fonte do <textarea>.
                 */
                parse: function(code) {
                    const lines = code.split('\n');
                    
                    lines.forEach(line => {
                        // Limpar linha (remover comentários e espaços extras)
                        let trimmedLine = line.split('#')[0].split('//')[0].trim();
                        if (!trimmedLine) return; // Ignora linhas vazias

                        // Quebra a instrução e seus operandos
                        const parts = trimmedLine.replace(/,/g, '').replace(/\(/, ' ').replace(/\)/, '').split(/\s+/).filter(p => p);
                        if (parts.length === 0) return;

                        const op = parts[0].toLowerCase();
                        let inst = { op: op, line: trimmedLine };

                        try {
                            switch (op) {
                                // R-type: add, sub
                                // Formato: op rd, rs1, rs2
                                case 'add':
                                case 'sub':
                                    inst.rd = this.parseRegister(parts[1]);
                                    inst.rs1 = this.parseRegister(parts[2]);
                                    inst.rs2 = this.parseRegister(parts[3]);
                                    break;

                                // I-type: addi
                                // Formato: op rd, rs1, imm
                                case 'addi':
                                    inst.rd = this.parseRegister(parts[1]);
                                    inst.rs1 = this.parseRegister(parts[2]);
                                    inst.imm = parseInt(parts[3]);
                                    break;

                                // Load-type: lw
                                // Formato: op rd, imm(rs1)
                                case 'lw':
                                    inst.rd = this.parseRegister(parts[1]);
                                    inst.imm = parseInt(parts[2]);
                                    inst.rs1 = this.parseRegister(parts[3]);
                                    break;

                                // Store-type: sw
                                // Formato: op rs2, imm(rs1)
                                case 'sw':
                                    inst.rs2 = this.parseRegister(parts[1]);
                                    inst.imm = parseInt(parts[2]);
                                    inst.rs1 = this.parseRegister(parts[3]);
                                    break;

                                // Branch-type: beq
                                // Formato: op rs1, rs2, imm (offset)
                                case 'beq':
                                    inst.rs1 = this.parseRegister(parts[1]);
                                    inst.rs2 = this.parseRegister(parts[2]);
                                    inst.imm = parseInt(parts[3]);
                                    break;

                                // Jump-type: jal
                                // Formato: op rd, imm (offset)
                                case 'jal':
                                    inst.rd = this.parseRegister(parts[1]);
                                    inst.imm = parseInt(parts[2]);
                                    break;

                                default:
                                    console.warn(`Instrução desconhecida ignorada: ${trimmedLine}`);
                                    return; // <<< CORREÇÃO AQUI (era 'continue;')
                            }
                            this.instructionMemory.push(inst);
                        } catch (e) {
                            console.error(`Erro ao parsear a linha: "${trimmedLine}"`, e);
                        }
                    });
                },

                // Executa um único ciclo de clock
                step: function() {
                    console.log("Executando 1 ciclo (step)...");
                    
                    // --- Lógica de Simulação (Placeholder Atualizado) ---
                    // Isso agora simula o *movimento* dos dados pelo pipeline.
                    // A lógica de execução real (add, lw, etc.) ainda não está aqui.

                    // --- Estágio WB (Write-Back) ---
                    if (this.pipelineStages.WB) {
                        // Uma instrução foi concluída!
                        this.metrics.instructions++;
                        // A lógica de escrita (ex: this.registers[rd] = result) viria aqui.
                    }

                    // --- Avanço do Pipeline (Shift) ---
                    this.pipelineStages.WB = this.pipelineStages.MEM;
                    this.pipelineStages.MEM = this.pipelineStages.EX;
                    this.pipelineStages.EX = this.pipelineStages.ID;
                    this.pipelineStages.ID = this.pipelineStages.IF;

                    // --- Estágio IF (Instruction Fetch) ---
                    if (this.pc < this.instructionMemory.length) {
                        // Busca a próxima instrução
                        const inst = this.instructionMemory[this.pc];
                        this.pipelineStages.IF = inst.line; // Usamos a string original para a UI
                        
                        // Avança o PC
                        // (!! IMPORTANTE: Desvios (beq, jal) irão modificar o pc
                        // em estágios posteriores, o que vai exigir lógica de stall/flush)
                        this.pc++; 
                    } else {
                        // Não há mais instruções para buscar
                        this.pipelineStages.IF = null;
                    }
                    
                    this.metrics.cycles++;
                    this.updateUI();
                },

                // Executa a simulação completa (placeholder)
                run: function() {
                    console.log("Executando simulação completa...");
                    alert("Função 'Executar (Completo)' ainda não implementada.");
                },

                // Atualiza toda a UI com base no estado atual
                updateUI: function() {
                    // 1. Atualizar Pipeline
                    this.ui.pipeline.if.textContent = this.pipelineStages.IF ?? 'vazio';
                    this.ui.pipeline.id.textContent = this.pipelineStages.ID ?? 'vazio';
                    this.ui.pipeline.ex.textContent = this.pipelineStages.EX ?? 'vazio';
                    this.ui.pipeline.mem.textContent = this.pipelineStages.MEM ?? 'vazio';
                    this.ui.pipeline.wb.textContent = this.pipelineStages.WB ?? 'vazio';

                    // 2. Atualizar Registradores
                    for (let i = 0; i < 32; i++) {
                        const val = this.registers[i];
                        const hexVal = '0x' + (val >>> 0).toString(16).padStart(8, '0');
                        document.getElementById(`reg-hex-${i}`).textContent = hexVal;
                        document.getElementById(`reg-dec-${i}`).textContent = val;
                    }

                    // 3. Atualizar Métricas
                    this.ui.metrics.pc.textContent = this.pc;
                    this.ui.metrics.cycles.textContent = this.metrics.cycles;
                    this.ui.metrics.instructions.textContent = this.metrics.instructions;
                    
                    const cpi = (this.metrics.instructions > 0) ? 
                                (this.metrics.cycles / this.metrics.instructions) : 0;
                    this.ui.metrics.cpi.textContent = cpi.toFixed(2);
                }
            };

            // Inicia o simulador
            simulator.init();
        });
    </script>

</body>
</html>